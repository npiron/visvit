!function(a){"use strict";function b(a,b){this.config=null,this.container=null,this.controls={},this.aspect=null,this.renderer=null,this.scene=null,this.camera=null,this.hotSpots=[],this.popover=!1,this.popoverTemplate=null,this.popoverCloseManual=!1,this.autoRotate={enabled:!1,speed:0},this.yaw={value:0,valuePrev:0,valueNext:0,time:0,duration:0},this.pitch={value:0,valuePrev:0,valueNext:0,time:0,duration:0,min:0,max:0},this.zoom={value:75,valuePrev:0,valueNext:0,time:0,duration:0,min:40,max:100},this.grabControl={enabled:!1,x:0,y:0,pitchSaved:0,yawSaved:0},this.hoverGrabControl={enabled:!1,pitchSaved:0,yawSaved:0},this.hotSpotSetupControl={enabled:!1,x:0,y:0,pitchSaved:0,yawSaved:0},this.animating=!1,this.loading=!1,this.xhr=null,this.timePrev=null,this.timeNext=null,this.timeInteraction=Date.now(),this.sceneId=null,this.init(a,b)}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();var c=function(){function a(){}return a.prototype.css2json=function(a){var b={};if(!a)return b;if(a instanceof CSSStyleDeclaration)for(var c in a)a[c].toLowerCase&&(b[a[c].toLowerCase()]=a[a[c]]);else if("string"==typeof a){a=a.split(";");for(var c in a){var d=a[c].split(":");2==d.length&&(b[d[0].toLowerCase().trim()]=d[1].trim())}}return b},a.prototype.webgl=function(){try{var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(b){return!1}},a.prototype.isMobile=function(a){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(a)},a.prototype.animationEvent=function(){var a=document.createElement("fakeelement"),b={animation:"animationend",MSAnimationEnd:"msAnimationEnd",OAnimation:"oAnimationEnd",MozAnimation:"mozAnimationEnd",WebkitAnimation:"webkitAnimationEnd"};for(var c in b)if(void 0!==a.style[c])return b[c]},a}(),d="ipanorama";b.prototype={defaults:{theme:"ipnrm-default",imagePreview:null,autoLoad:!1,autoRotate:!1,autoRotateInactivityDelay:3e3,mouseWheelRotate:!1,mouseWheelRotateCoef:.2,mouseWheelZoom:!0,mouseWheelZoomCoef:.05,hoverGrab:!1,hoverGrabYawCoef:20,hoverGrabPitchCoef:20,grab:!0,grabCoef:.1,showControlsOnHover:!1,showZoomCtrl:!0,showFullscreenCtrl:!0,keyboardNav:!0,keyboardZoom:!0,title:!0,compass:!0,popover:!0,popoverTemplate:"<div class='ipnrm-popover'><div class='ipnrm-close'></div><div class='ipnrm-arrow'></div><div class='ipnrm-content'></div></div>",popoverPlacement:"top",popoverShowTrigger:"hover",popoverHideTrigger:"leave",popoverShowClass:null,popoverHideClass:null,sceneId:null,sceneFadeDuration:3e3,scenes:{defaults:{type:"cube",image:"",yaw:0,pitch:0,titleHtml:!1,title:null,compassNorthOffset:null,hotSpots:[]}},pitchLimits:!0,hotSpotSetup:!1,mobile:!1},id:0,cameraNearClipPlane:.1,cameraFarClipPlane:1e3,init:function(a,b){this.container=a,this.config=b,this.initScenes(),b.autoRotate&&(this.autoRotate.enabled=!0,this.autoRotate.speed=b.autoRotate/1e3,this.timeInteraction=Date.now()-this.config.autoRotateInactivityDelay),this.create()},initScenes:function(){for(var c in this.config.scenes)if(this.config.scenes.hasOwnProperty(c)){var d=a.extend({},b.prototype.defaults.scenes.defaults,this.config.scenes[c]);this.config.scenes[c]=d}},create:function(){this.checkAnimation(),this.buildDOM(),this.resetHandlers(),this.util().webgl()?(this.applyHandlers(),this.resetHotSpots(),this.applyHotSpots(),this.applyPopover(),this.config.autoLoad&&this.loadScene(this.config.sceneId)):(this.hideLoadInfo(),this.controls.$info.html("<p>Your browser does not support WebGL</p>"),this.controls.$info.fadeIn())},checkAnimation:function(){var a=!this.config.mobile&&this.util().isMobile(navigator.userAgent);(void 0==this.util().animationEvent()||a)&&(this.config.popoverShowClass=null,this.config.popoverHideClass=null)},loadScene:function(b){if(!this.config.scenes.hasOwnProperty(b))throw this.showMessage("<p>Cannot load '"+b+"' scene</p>"),Error("Cannot load '"+b+"' scene");if(this.loading&&this.xhr&&4!=this.xhr.readyState&&this.xhr.abort(),this.loading=!0,this.showLoadInfo(),this.sceneId){var c=this.config.scenes[this.sceneId];c.pitch=this.pitch.value,c.yaw=this.yaw.value}var c=this.config.scenes[b];this.pitch.value=c.pitch,this.yaw.value=c.yaw;var d={},e=0,f=0,g={};if("string"==typeof c.image)d.image=c.image;else{if(!(c.image.hasOwnProperty("left")&&c.image.hasOwnProperty("right")&&c.image.hasOwnProperty("top")&&c.image.hasOwnProperty("bottom")&&c.image.hasOwnProperty("front")&&c.image.hasOwnProperty("back")))throw this.controls.$loadInfo.fadeTo("slow",0),this.showMessage("<p>Wrong parameter value for texture</p>"),Error("Wrong parameter value for texture");d.right=c.image.right,d.left=c.image.left,d.top=c.image.top,d.bottom=c.image.bottom,d.front=c.image.front,d.back=c.image.back}for(var h in d)d.hasOwnProperty(h)&&e++;for(var h in d)if(d.hasOwnProperty(h)){this.xhr=new XMLHttpRequest;var i=this.xhr;i.open("GET",d[h],!0),i.crossOrigin="Anonymous",i.responseType="arraybuffer",i.customKey=h,i.onprogress=a.proxy(function(a){var b=a.currentTarget;if(a.lengthComputable){g[b.customKey]={total:a.total,loaded:a.loaded};var c,d;for(var e in g)g.hasOwnProperty(e)&&(c=g[e].total,d=g[e].loaded);var f=Math.floor(d/c*100)+"%";this.controls.$loadProgressBar.stop().animate({width:f})}},this),i.onload=a.proxy(function(c){var g=c.currentTarget;if(g.status>=400)return g.onerror(c);var h=new Blob([g.response]),i=new Image;i.onload=a.proxy(function(a){d[a.customKey]=i,++f==e&&(this.hideLoadInfo(),this.applyControls(b),this.loading=!1,this.applyPitchLimits(b),this.resetTransition(),this.buildScene(b,d),this.animateStart())},this,g),i.onerror=a.proxy(function(a){if(++f==e)throw this.hideLoadInfo(),this.showMessage("<p>Cannot load texture</p>"),Error("Cannot load texture '"+d[a.customKey]+"'")},this,g),i.src=window.URL.createObjectURL(h)},this),i.onerror=a.proxy(function(a){var b=a.currentTarget;throw this.hideLoadInfo(),this.showMessage("<p>Cannot load texture</p>"),Error("Cannot load texture '"+d[b.customKey]+"'")},this),i.send()}},applyPitchLimits:function(a){var b=this.config.scenes[a];this.config.pitchLimits?"cube"==b.type?(this.pitch.min=-70,this.pitch.max=70):"sphere"==b.type?(this.pitch.min=-35,this.pitch.max=35):"cylinder"==b.type&&(this.pitch.min=-5,this.pitch.max=5):(this.pitch.min=-89,this.pitch.max=89)},applyHotSpots:function(){for(var b in this.config.scenes)if(this.config.scenes.hasOwnProperty(b)){for(var c=this.config.scenes[b],d=JSON.parse(JSON.stringify(c.hotSpots)),e=0,f=d.length;f>e;e++){var g=d[e];if(g.yaw=g.yaw?g.yaw:0,g.pitch=g.pitch?g.pitch:0,g.sceneOwnerId=b,g.xyz=this.getPitchYawPoint(g.pitch,g.yaw),g.visible=!1,g.$el=a("<div class='ipnrm-hotspot"+(g.additionalClasses?" "+g.additionalClasses:"")+"' style='display: none;'></div>"),g.$popover=null,"string"==typeof g.sceneId&&(g.$el.addClass("ipnrm-hotspot-scene"),g.$el.on("click.ipanorama",a.proxy(this.onHotSpotSceneClick,this,g))),"function"==typeof c.hotSpots[e].popoverContent&&(g.popoverContent=c.hotSpots[e].popoverContent),g.popoverContent){for(var h=this.config.popoverShowTrigger.split(" "),i=h.length;i--;){var j=h[i];"click"==j?g.$el.on("click.ipanorama",a.proxy(this.onHotSpotClick,this,g)):"hover"==j&&g.$el.on("mouseenter.ipanorama",a.proxy(this.onHotSpotEnter,this,g))}for(var h=this.config.popoverHideTrigger.split(" "),i=h.length;i--;){var j=h[i];"click"==j?g.$el.on("click.ipanorama",a.proxy(this.onPopoverHide,this,g)):"grab"==j?a("body").add(this.controls.$view).on("mousedown",a.proxy(this.onPopoverHide,this,g)):"leave"==j?g.$el.on("mouseleave.ipanorama",a.proxy(this.onHotSpotLeave,this,g)):this.popoverCloseManual=!0}}this.controls.$hotspots.append(g.$el)}this.hotSpots=this.hotSpots.concat(d)}},resetHotSpots:function(){this.controls.$hotspots.children().fadeTo("slow",0,function(){a(this).remove()})},applyPopover:function(){if(this.popover=this.config.popover,this.popover){var b=a(this.config.popoverTemplate);if(1!=b.length)throw this.popover=!1,new Error("'popoverTemplate' option must consist of exactly 1 top-level element!");this.popoverTemplate=this.config.popoverTemplate}},showPopover:function(b){if(this.popover&&b.visible&&b.popoverContent){if(!b.$popover){b.$popover=a(this.popoverTemplate);var c=this.getPopoverUID("popover");b.$popover.attr("id",c),this.popoverCloseManual&&(b.$popover.addClass("ipnrm-close"),b.$popover.find(".ipnrm-close").on("click.ipanorama",a.proxy(this.onPopoverHide,this,b)))}var d=b.$popover;if(!d.hasClass("ipnrm-active")||b.$popover.hasClass(this.config.popoverHideClass)){var e=this.getPopoverContent(b);d.find(".ipnrm-content").children().detach().end()[b.popoverHtml?"string"==typeof e?"html":"append":"text"](e),d.detach().css({top:0,left:0,width:""}),d.removeClass(this.config.popoverHideClass),d.removeClass(this.config.popoverShowClass),d.appendTo(this.controls.$panorama),d.css({width:d[0].offsetWidth})}var f=this.config.popoverPlacement;b.popoverPlacement&&(f=b.popoverPlacement);var g=this.getPopoverPosition(b),h=d[0].offsetWidth,i=d[0].offsetHeight;f="bottom"==f&&g.bottom+i>window.pageYOffset+window.innerHeight?"top":"top"==f&&g.top-i<window.pageYOffset?"bottom":"right"==f&&g.right+h>window.pageXOffset+window.innerWidth?"left":"left"==f&&g.left-h<window.pageYOffset?"right":f;var j=this.getPopoverOffset(f,g,h,i);this.applyPopoverPlacement(b,j,f),d.hasClass("ipnrm-active")||(d.removeClass(this.config.popoverHideClass),d.addClass(this.config.popoverShowClass),this.config.popoverShowClass?(b.$popover.css("visibility","visible"),b.$popover.one(this.util().animationEvent(),a.proxy(function(b){var c=a(b.target);c.hasClass(this.config.popoverHideClass)||(c.addClass("ipnrm-active"),c.removeClass(this.config.popoverShowClass)),c.css("visibility","")},this))):d.addClass("ipnrm-active"))}},hidePopover:function(b){b.$popover&&(b.$popover.hasClass("ipnrm-active")||b.$popover.hasClass(this.config.popoverShowClass))&&(b.$popover.removeClass(this.config.popoverShowClass),b.$popover.addClass(this.config.popoverHideClass),this.config.popoverHideClass?b.$popover.one(this.util().animationEvent(),a.proxy(function(c){var d=a(c.target);d.hasClass(this.config.popoverShowClass)||(d.removeClass("ipnrm-active"),b.$popover.detach(),b.$popover.get(0).offsetHeight,b.$popover.appendTo(this.controls.$panorama),d.removeClass(this.config.popoverHideClass))},this)):(b.$popover.removeClass("ipnrm-active"),b.$popover.detach(),b.$popover.get(0).offsetHeight,b.$popover.appendTo(this.controls.$panorama)))},getPopoverContent:function(a){return"function"==typeof a.popoverContent?a.popoverContent.call(a):a.popoverContent},getPopoverPosition:function(b){var c=b.$el,d=c.get(0),e=d.getBoundingClientRect(),f=c.offset();return a.extend({},e,f)},getPopoverOffset:function(a,b,c,d){return"bottom"==a?{top:b.top+b.height,left:b.left+b.width/2-c/2}:"top"==a?{top:b.top-d,left:b.left+b.width/2-c/2}:"left"==a?{top:b.top+b.height/2-d/2,left:b.left-c}:{top:b.top+b.height/2-d/2,left:b.left+b.width}},applyPopoverPlacement:function(b,c,d){var e=b.$popover,f=(e[0].offsetWidth,e[0].offsetHeight,parseInt(e.css("margin-top"),10)),g=parseInt(e.css("margin-left"),10);isNaN(f)&&(f=0),isNaN(g)&&(g=0),c.top+=f,c.left+=g,a.offset.setOffset(e[0],a.extend({using:function(a){e.css({top:Math.round(a.top),left:Math.round(a.left)})}},c),0);for(var h=["top","left","bottom","right"],i=h.length;i--;)if(h[i]==d){h.splice(i,1);break}for(var i=h.length;i--;)e.removeClass("ipnrm-popover-"+h[i]);e.addClass("ipnrm-popover-"+d)},getPopoverUID:function(a){do a+=~~(1e6*Math.random());while(document.getElementById(a));return a},buildDOM:function(){this.container.empty(),this.controls.$panorama=a("<div class='ipnrm"+(this.config.theme?" "+this.config.theme:"")+(this.config.showControlsOnHover?" ipnrm-hide-controls":"")+"' tabindex='1'></div>"),this.controls.$view=a("<div class='ipnrm-view'></div>"),this.controls.$preview=a("<div class='ipnrm-preview'></div>"),this.config.imagePreview&&this.controls.$preview.css("background-image","url("+this.config.imagePreview+")"),this.controls.$scene=a("<div class='ipnrm-scene'></div>"),this.controls.$hotspots=a("<div class='ipnrm-hotspots'></div>"),this.setViewCursorShape("ipnrm-grab"),this.controls.$view.append(this.controls.$preview),this.controls.$view.append(this.controls.$scene),this.controls.$view.append(this.controls.$hotspots),this.controls.$loadBtn=a("<div class='ipnrm-btn-load'><p>click to<br>load<br>panorama</p></div>"),this.controls.$loadInfo=a("<div class='ipnrm-load-info' style='display:none'></div>"),this.controls.$loadInfoInner=a("<div class='ipnrm-load-info-inner'><p>Loading</p></div>"),this.controls.$loadProgress=a("<div class='ipnrm-load-progress'></div>"),this.controls.$loadProgressBar=a("<div class='ipnrm-load-progress-bar'></div>"),this.controls.$loadProgress.append(this.controls.$loadProgressBar),this.controls.$loadInfoInner.append(this.controls.$loadProgress),this.controls.$loadInfo.append(this.controls.$loadInfoInner),this.controls.$info=a("<div class='ipnrm-info' style='display:none'></div>"),this.controls.$toolbar=a("<div class='ipnrm-toolbar'></div>"),this.controls.$zoomIn=a("<div class='ipnrm-btn-zoom-in ipnrm-btn' style='display:none'></div>"),this.controls.$zoomOut=a("<div class='ipnrm-btn-zoom-out ipnrm-btn' style='display:none'></div>"),this.controls.$fullscreen=a("<div class='ipnrm-btn-fullscreen ipnrm-btn' style='display:none'></div>"),this.controls.$compass=a("<div class='ipnrm-compass' style='display:none'></div>"),this.controls.$title=a("<div class='ipnrm-title' style='display:none'></div>"),this.container.append(this.controls.$panorama),this.controls.$panorama.append(this.controls.$view,this.controls.$loadBtn,this.controls.$loadInfo,this.controls.$info,this.controls.$toolbar,this.controls.$zoomIn,this.controls.$zoomOut,this.controls.$fullscreen,this.controls.$compass,this.controls.$title),this.controls.$panorama.focus()},buildScene:function(b,c){var d=this.controls.$panorama.width(),e=this.controls.$panorama.height();this.sceneId=b,this.aspect=d/e,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(this.zoom.value,this.aspect,this.cameraNearClipPlane,this.cameraFarClipPlane),this.buildGeomentry(b,c),this.renderer=new THREE.WebGLRenderer,this.renderer.setSize(d,e);var f=a(this.renderer.domElement);f.fadeTo(0,0),this.controls.$scene.append(f),f.fadeTo(this.config.sceneFadeDuration,1,a.proxy(function(){this.controls.$scene.children().length>1&&this.controls.$scene.children(":first-child").remove()},this))},buildGeomentry:function(a,b){var c=this.config.scenes[a];"cube"==c.type?this.buildCube(b):"sphere"==c.type?this.buildSphere(b):"cylinder"==c.type&&this.buildCylinder(b)},buildCube:function(a){var b=new THREE.BoxGeometry(100,100,100);b.scale(-1,1,1);var c=[];c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"right"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"left"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"top"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"bottom"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"front"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"back"),side:THREE.FrontSide}));var d=new THREE.MeshFaceMaterial(c),e=new THREE.Mesh(b,d);this.scene.add(e)},buildSphere:function(a){var b=new THREE.SphereGeometry(100,100,40);b.scale(-1,1,1);var c=new THREE.MeshBasicMaterial({side:THREE.FrontSide});a.hasOwnProperty("image")&&(c.map=this.createTexture(a,"image"));var d=new THREE.Mesh(b,c);this.scene.add(d)},buildCylinder:function(a){var b=new THREE.CylinderGeometry(100,100,200,40);b.scale(-1,1,1);var c=new THREE.MeshBasicMaterial({side:THREE.FrontSide});a.hasOwnProperty("image")&&(c.map=this.createTexture(a,"image"));var d=new THREE.Mesh(b,c);this.scene.add(d)},animateStart:function(){"undefined"!=typeof performance&&performance.now()?this.timePrev=performance.now():this.timePrev=Date.now(),this.animating||this.loading||(this.animating=!0,this.animate())},animate:function(){return this.loading?void(this.animating=!1):(this.renderScene(),this.controlHotSpots(),this.controlCompass(),void(this.grabControl.enabled?(this.controlHoverGrabControl(),this.animationId=requestAnimationFrame(a.proxy(this.animate,this))):this.isTransition()||this.hoverGrabControl.enabled?(this.applyTransition(),this.controlHoverGrabControl(),this.animationId=requestAnimationFrame(a.proxy(this.animate,this))):this.animating=!1))},isTransition:function(){return this.autoRotate.enabled||this.yaw.time<this.yaw.duration||this.pitch.time<this.pitch.duration||this.zoom.time<this.zoom.duration?!0:!1},applyTransition:function(){"undefined"!=typeof performance&&performance.now()?this.timeNext=performance.now():this.timeNext=Date.now(),void 0===this.timePrev&&(this.timePrev=this.timeNext);var a=this.timeNext-this.timePrev,b=Date.now()-this.timeInteraction;this.autoRotate.enabled&&b>this.config.autoRotateInactivityDelay&&(this.yaw.value-=this.autoRotate.speed*a),this.applyInterpolation(this.yaw,a),this.applyInterpolation(this.pitch,a),this.applyInterpolation(this.zoom,a),this.pitch.value=Math.max(this.pitch.min,Math.min(this.pitch.max,this.pitch.value)),this.zoom.value=Math.max(this.zoom.min,Math.min(this.zoom.max,this.zoom.value)),this.timePrev=this.timeNext},resetTransition:function(){this.yaw.time=this.yaw.duration,this.pitch.time=this.pitch.duration,this.zoom.time=this.zoom.duration},resetScene:function(){this.animationId&&cancelAnimationFrame(this.animationId),this.renderer=null,this.scene=null,this.camera=null,this.container.empty()},renderScene:function(){this.camera.fov!=this.zoom.value&&(this.camera.fov=this.zoom.value,this.camera.updateProjectionMatrix()),this.camera.lookAt(this.getPitchYawPoint(this.pitch.value,this.yaw.value)),this.renderer.render(this.scene,this.camera)},controlCompass:function(){if(this.config.compass&&this.sceneId&&this.config.scenes[this.sceneId].compassNorthOffset){var a=this.config.scenes[this.sceneId].compassNorthOffset,b=a-this.yaw.value;this.controls.$compass.css({transform:"rotate("+b+"deg)"})}},controlHotSpots:function(){var a=this.controls.$panorama.width(),b=this.controls.$panorama.height(),c=new THREE.Frustum;c.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse));for(var d=this.hotSpots.length;d--;){var e=this.hotSpots[d];c.containsPoint(e.xyz)&&e.sceneOwnerId==this.sceneId?e.visible?this.updateHotSpots(this.camera,a,b,e):(e.visible=!0,e.$el.fadeIn(),e.$popover&&e.$popover.removeClass("ipnrm-hidden"),this.updateHotSpots(this.camera,a,b,e)):e.visible&&(e.visible=!1,e.$el.fadeOut(),e.$popover&&e.$popover.addClass("ipnrm-hidden"),this.updateHotSpots(this.camera,a,b,e)),e.$popover&&e.$popover.hasClass("ipnrm-active")&&!e.$popover.hasClass(this.config.popoverHideClass)&&this.showPopover(e)}},updateHotSpots:function(a,b,c,d){var e=this.getHotSpotScreenPos(d,a,b,c);d.$el.css({top:e.y-d.$el.height()/2,left:e.x-d.$el.width()/2})},getHotSpotScreenPos:function(a,b,c,d){var e=new THREE.Vector3(a.xyz.x,a.xyz.y,a.xyz.z);return e.project(b),e.x=(e.x+1)/2*c,e.y=-(e.y-1)/2*d,{x:e.x,y:e.y}},applyHandlers:function(){this.controls.$loadBtn.on("click.ipanorama",a.proxy(this.onLoad,this)),this.controls.$zoomIn.on("click.ipanorama",a.proxy(this.onZoomIn,this)),this.controls.$zoomOut.on("click.ipanorama",a.proxy(this.onZoomOut,this)),this.controls.$fullscreen.on("click.ipanorama",a.proxy(this.onFullScreen,this)),this.controls.$view.on("click.ipanorama",a.proxy(this.onMouseClick,this)),this.controls.$view.on("mousewheel.ipanorama DOMMouseScroll.ipanorama",a.proxy(this.onMouseWheel,this)),this.config.grab&&(this.controls.$view.on("mousedown.ipanorama",a.proxy(this.onGrabMouseDown,this)),this.controls.$view.on("touchstart.ipanorama",a.proxy(this.onGrabTouchStart,this)),this.controls.$view.on("touchmove.ipanorama",a.proxy(this.onGrabTouchMove,this)),this.controls.$view.on("touchend.ipanorama",a.proxy(this.onGrabTouchEnd,this))),this.config.showControlsOnHover&&(this.controls.$panorama.one("mousemove.ipanorama",a.proxy(this.onPanoramaEnter,this)),this.controls.$panorama.on("mouseenter.ipanorama",a.proxy(this.onPanoramaEnter,this)),this.controls.$panorama.on("mouseleave.ipanorama",a.proxy(this.onPanoramaLeave,this))),this.config.hoverGrab&&(this.controls.$panorama.on("mouseenter.ipanorama",a.proxy(this.onHoverGrabEnter,this)),this.controls.$panorama.on("mouseleave.ipanorama",a.proxy(this.onHoverGrabLeave,this))),this.controls.$panorama.on("blur.ipanorama",a.proxy(this.onBlur,this)),this.controls.$panorama.on("keydown.ipanorama",a.proxy(this.onKeyDown,this)),this.controls.$panorama.on("keyup.ipanorama",a.proxy(this.onKeyUp,this)),this.controls.$panorama.on("fullscreenchange.ipanorama mozfullscreenchange.ipanorama webkitfullscreenchange.ipanorama msfullscreenchange.ipanorama",a.proxy(this.onFullScreenChange,this)),a(window).on("resize.ipanorama",a.proxy(this.onResize,this)),a(window).on("blur.ipanorama",a.proxy(this.onBlur,this))},resetHandlers:function(){this.controls.$loadBtn.off("click.ipanorama"),this.controls.$zoomIn.off("click.ipanorama"),this.controls.$zoomOut.off("click.ipanorama"),this.controls.$fullscreen.off("click.ipanorama"),this.controls.$view.off("click.ipanorama"),this.controls.$view.off("mousewheel.ipanorama DOMMouseScroll.ipanorama"),this.config.grab&&(this.controls.$view.off("mousedown.ipanorama"),this.controls.$view.off("touchstart.ipanorama"),this.controls.$view.off("touchmove.ipanorama"),this.controls.$view.off("touchend.ipanorama")),this.config.showControlsOnHover&&(this.controls.$panorama.off("mouseenter.ipanorama"),this.controls.$panorama.off("mouseleave.ipanorama")),this.controls.$panorama.off("blur.ipanorama"),this.controls.$panorama.off("keydown.ipanorama"),this.controls.$panorama.off("keyup.ipanorama"),this.controls.$panorama.off("fullscreenchange.ipanorama mozfullscreenchange.ipanorama webkitfullscreenchange.ipanorama msfullscreenchange.ipanorama"),a(window).off("mousemove.ipanorama"),a(window).off("mouseup.ipanorama"),a(window).off("resize.ipanorama"),a(window).off("blur.ipanorama")},onHotSpotSceneClick:function(a,b){b.preventDefault(),b.stopPropagation(),this.loadScene(a.sceneId)},onHotSpotClick:function(a,b){a.$popover&&a.$popover.hasClass("ipnrm-active")||b.stopImmediatePropagation(),this.showPopover(a)},onHotSpotEnter:function(a,b){this.showPopover(a)},onHotSpotLeave:function(b,c){if(b.$popover){var d=c.toElement||c.relatedTarget;0!==b.$popover.has(d).length||b.$popover.is(d)||b.$el.is(d)?b.$popover.one("mouseleave.ipanorama",a.proxy(this.onHotSpotLeave,this,b)):this.hidePopover(b)}},onPopoverHide:function(b,c){b.$popover&&(console.log(b.$popover.has(c.target).length),(0===b.$popover.has(c.target).length||a(c.target).hasClass("ipnrm-close"))&&(a(c.target).hasClass("ipnrm-close")&&(c.stopImmediatePropagation(),console.log("preventDefault")),this.hidePopover(b)))},onFullScreenChange:function(){document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement?(this.controls.$panorama.addClass("ipnrm-fullscreen"),this.controls.$fullscreen.addClass("ipnrm-active")):(this.controls.$panorama.removeClass("ipnrm-fullscreen"),this.controls.$fullscreen.removeClass("ipnrm-active"))},toggleFullScreen:function(){if(!this.isLoading())if(this.controls.$fullscreen.hasClass("ipnrm-active"))try{document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}catch(a){}else try{var b=this.controls.$panorama.get(0);b.requestFullscreen?b.requestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullscreen?b.webkitRequestFullscreen():b.msRequestFullscreen&&b.msRequestFullscreen()}catch(a){}},onFullScreen:function(){this.toggleFullScreen()},onMouseClick:function(a){this.getNewHotSpot(a)},onGrabMouseDown:function(b){b.preventDefault(),b.stopPropagation(),this.isLoading()||this.hotSpotSetupControl.enabled||(this.controls.$panorama.focus(),this.applyGrabControl(b),a(window).on("mousemove.ipanorama",a.proxy(this.onGrabMouseMove,this)),a(window).on("mouseup.ipanorama",a.proxy(this.onGrabMouseUp,this)))},onGrabMouseMove:function(a){this.updateGrabControl(a)},onGrabMouseUp:function(b){this.resetGrabControl(b),a(window).off("mousemove.ipanorama"),a(window).off("mouseup.ipanorama")},onGrabTouchStart:function(a){this.isLoading()||this.applyGrabControl(a)},onGrabTouchMove:function(a){if(!this.isLoading()&&(a.preventDefault(),this.grabControl.enabled)){var b=this.getMousePosition(a.originalEvent.targetTouches[0]);this.yaw.valuePrev=this.yaw.value,this.pitch.valuePrev=this.pitch.value,this.yaw.value=(this.grabControl.x-b.x)*this.config.grabCoef+this.grabControl.yawSaved,this.pitch.value=(b.y-this.grabControl.y)*this.config.grabCoef+this.grabControl.pitchSaved,this.pitch.value=Math.max(this.pitch.min,Math.min(this.pitch.max,this.pitch.value))}},onGrabTouchEnd:function(a){this.grabControl.enabled=!1},onHoverGrabEnter:function(b){this.hoverGrabControl.enabled||(this.hoverGrabControl.enabled=!0,this.controls.$panorama.on("mousemove.ipanorama",a.proxy(this.onHoverGrabMove,this)),this.resetTransition(),this.animateStart())},onHoverGrabLeave:function(a){this.hoverGrabControl.enabled&&(this.hoverGrabControl.enabled=!1,this.controls.$panorama.off("mousemove.ipanorama"))},onHoverGrabMove:function(a){if(!this.isLoading()){var b=this.getMousePositionPower(a);this.hoverGrabControl.power=b,this.hoverGrabControl.enabled&&!this.grabControl.enabled&&(this.yaw.valuePrev=this.yaw.value,this.pitch.valuePrev=this.pitch.value,this.yaw.value=this.hoverGrabControl.yawSaved+b.x*this.config.hoverGrabYawCoef,this.pitch.value=this.hoverGrabControl.pitchSaved+b.y*this.config.hoverGrabPitchCoef,this.pitch.value=Math.max(this.pitch.min,Math.min(this.pitch.max,this.pitch.value)))}},onPanoramaEnter:function(a){this.controls.$panorama.removeClass("ipnrm-hide-controls")},onPanoramaLeave:function(a){this.controls.$panorama.addClass("ipnrm-hide-controls")},onKeyDown:function(a){return this.isLoading()?void 0:(this.autoRotate.enabled=!1,this.timeInteraction=Date.now(),a.ctrlKey&&this.config.hotSpotSetup&&!this.grabControl.enabled?void this.applyHotSpotSetupControl():void(38===a.keyCode&&this.config.keyboardNav===!0?this.setPitch(this.pitch.value+10):40===a.keyCode&&this.config.keyboardNav===!0?this.setPitch(this.pitch.value-10):37===a.keyCode&&this.config.keyboardNav===!0?this.setYaw(this.yaw.value-10):39===a.keyCode&&this.config.keyboardNav===!0?this.setYaw(this.yaw.value+10):189!==a.keyCode&&109!==a.keyCode||this.config.keyboardZoom!==!0?187!==a.keyCode&&107!==a.keyCode||this.config.keyboardZoom!==!0||this.setZoom(this.zoom.value-10):this.setZoom(this.zoom.value+10)))},onKeyUp:function(a){this.config.hotSpotSetup&&this.resetHotSpotSetupControl(),this.config.autoRotate&&(this.autoRotate.enabled=!0,this.timeInteraction=Date.now(),this.animateStart())},resize:function(){if(!this.isLoading()){var a=this.controls.$panorama.width(),b=this.controls.$panorama.height();this.aspect=a/b,this.camera.aspect=this.aspect,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.animateStart()}},onResize:function(a){this.resize(),this.onFullScreenChange()},onBlur:function(a){this.resetHotSpotSetupControl(),this.timePrev=void 0},onLoad:function(){this.loadScene(this.config.sceneId)},onZoomIn:function(a){this.isLoading()||this.setZoom(this.zoom.value-10)},onZoomOut:function(a){this.isLoading()||this.setZoom(this.zoom.value+10)},onMouseWheel:function(a){if(a.preventDefault(),!this.isLoading()){var a=a.originalEvent;a.wheelDeltaY?this.config.mouseWheelRotate?this.setYaw(this.yaw.value-a.wheelDeltaY*this.config.mouseWheelRotateCoef):this.config.mouseWheelZoom&&this.setZoom(this.zoom.value-a.wheelDeltaY*this.config.mouseWheelZoomCoef):a.wheelDelta?this.config.mouseWheelRotate?this.setYaw(this.yaw.value-a.wheelDelta*this.config.mouseWheelRotateCoef):this.config.mouseWheelZoom&&this.setZoom(this.zoom.value-a.wheelDelta*this.config.mouseWheelZoomCoef):a.detail&&(this.config.mouseWheelRotate?this.setYaw(this.yaw.value+a.detail*this.config.mouseWheelRotateCoef*100):this.config.mouseWheelZoom&&this.setZoom(this.zoom.value+a.detail*this.config.mouseWheelZoomCoef*100))}},setYaw:function(a,b){this.yaw.valuePrev=this.yaw.value,this.yaw.valueNext=a,this.yaw.time=0,this.yaw.duration=b?b:1e3,this.animateStart()},setPitch:function(a,b){this.pitch.valuePrev=this.pitch.value,this.pitch.valueNext=a,this.pitch.time=0,this.pitch.duration=b?b:1e3,this.animateStart()},setZoom:function(a,b){this.zoom.valuePrev=this.zoom.value,this.zoom.valueNext=a,this.zoom.time=0,this.zoom.duration=b?b:500,this.animateStart()},applyGrabControl:function(a){this.setViewCursorShape("ipnrm-grabbing"),this.autoRotate.enabled=!1,this.timeInteraction=Date.now();var b={x:0,y:0};window.TouchEvent&&a.originalEvent instanceof TouchEvent?b=this.getMousePosition(a.originalEvent.targetTouches[0]):(b.x=a.clientX,b.y=a.clientY),this.grabControl.enabled=!0,this.grabControl.x=b.x,this.grabControl.y=b.y,this.grabControl.yawSaved=this.yaw.value,this.grabControl.pitchSaved=this.pitch.value,this.resetTransition(),this.animateStart()},updateGrabControl:function(a){if(this.grabControl.enabled){this.timeInteraction=Date.now();var b={x:0,y:0};window.TouchEvent&&a.originalEvent instanceof TouchEvent?b=this.getMousePosition(a.originalEvent.targetTouches[0]):(b.x=a.clientX,b.y=a.clientY),this.yaw.valuePrev=this.yaw.value,this.pitch.valuePrev=this.pitch.value,this.yaw.value=(this.grabControl.x-b.x)*this.config.grabCoef+this.grabControl.yawSaved,this.pitch.value=(b.y-this.grabControl.y)*this.config.grabCoef+this.grabControl.pitchSaved,this.pitch.value=Math.max(this.pitch.min,Math.min(this.pitch.max,this.pitch.value))}},resetGrabControl:function(a){if(this.grabControl.enabled){this.config.autoRotate&&(this.autoRotate.enabled=!0),this.grabControl.enabled=!1,this.setViewCursorShape("ipnrm-grab"),this.controlHoverGrabControl();var b=this.yaw.value-this.grabControl.yawSaved,c=this.pitch.value-this.grabControl.pitchSaved;this.setYaw(this.yaw.value+1*Math.sign(b),500),this.setPitch(this.pitch.value+1*Math.sign(c),500)}},controlHoverGrabControl:function(){if(this.config.hoverGrab&&this.hoverGrabControl.power){var a=this.hoverGrabControl.power,b=this.yaw.value-a.x*this.config.hoverGrabYawCoef,c=this.pitch.value-a.y*this.config.hoverGrabPitchCoef;c=Math.max(this.pitch.min,Math.min(this.pitch.max,c)),this.hoverGrabControl.yawSaved=b,this.hoverGrabControl.pitchSaved=c}},applyHotSpotSetupControl:function(){this.hotSpotSetupControl.enabled||(this.setViewCursorShape("ipnrm-target"),this.hotSpotSetupControl.enabled=!0)},getNewHotSpot:function(a){if(this.hotSpotSetupControl.enabled){var b=this.controls.$view.offset(),c=a.pageX-b.left,d=a.pageY-b.top,e=this.controls.$view.get(0).getBoundingClientRect(),f=e.right-e.left,g=e.bottom-e.top,h=c/f*2-1,i=1-d/g*2,j=new THREE.Vector3(h,i,.5);j.unproject(this.camera);var k=j.sub(this.camera.position).normalize(),l=Math.atan(k.x/k.z),m=Math.atan(k.y/Math.sqrt(k.z*k.z+k.x*k.x));l=-THREE.Math.radToDeg(l),m=THREE.Math.radToDeg(m),k.z<=0?l=180+l:k.x>0&&(l=360+l),console.log("yaw: "+l+", pitch: "+m+", camera yaw: "+this.yaw.value+", camera pitch: "+this.pitch.value+", camera zoom: "+this.zoom.value)}},resetHotSpotSetupControl:function(){this.setViewCursorShape("ipnrm-grab"),this.hotSpotSetupControl.enabled=!1},setViewCursorShape:function(a){this.controls.$view.removeClass("ipnrm-grab"),this.controls.$view.removeClass("ipnrm-grabbing"),this.controls.$view.removeClass("ipnrm-target"),(this.config.grab||"ipnrm-target"==a)&&this.controls.$view.addClass(a)},isLoading:function(){return this.loading||!this.scene},getPitchYawPoint:function(a,b){var c=new THREE.Vector3(0,0,0);
return c.x=Math.sin(THREE.Math.degToRad(180-b))*Math.cos(THREE.Math.degToRad(180-a)),c.y=Math.sin(THREE.Math.degToRad(180-a)),c.z=Math.cos(THREE.Math.degToRad(180-b))*Math.cos(THREE.Math.degToRad(180-a)),c},getMousePositionPower:function(a){var b=this.controls.$panorama.get(0).getBoundingClientRect(),c={},d=(b.right-b.left)/2,e=(b.bottom-b.top)/2,f=document.body,g=document.documentElement,h=window.pageYOffset||g.scrollTop||f.scrollTop,i=window.pageXOffset||g.scrollLeft||f.scrollLeft,j=g.clientTop||f.clientTop||0,k=g.clientLeft||f.clientLeft||0,l=b.top+h-j,m=b.left+i-k,l=Math.round(l),m=Math.round(m),l=a.pageY-l,m=a.pageX-m;return c.x=(m-d)/d,c.y=(e-l)/e,c.x=c.x<-1?-1:c.x>1?1:c.x,c.y=c.y<-1?-1:c.y>1?1:c.y,c},applyInterpolation:function(a,b){if(a.time<a.duration){a.time+=b;var c=a.time/a.duration;a.value=a.valuePrev+(a.valueNext-a.valuePrev)*c}},createTexture:function(a,b){var c=new THREE.Texture;return c.image=a[b],c.needsUpdate=!0,c},getMousePosition:function(a){var b=this.controls.$panorama.get(0).getBoundingClientRect(),c={};return c.x=a.clientX-b.left,c.y=a.clientY-b.top,c},showLoadInfo:function(){this.controls.$loadProgressBar.css({width:0}),this.controls.$loadInfo.css({display:""}).fadeTo("slow",1)},hideLoadInfo:function(){this.controls.$loadBtn.hide(),this.controls.$loadInfo.fadeTo("slow",0,function(){a(this).css({display:"none"})})},applyControls:function(a){this.config.showZoomCtrl?(this.controls.$zoomIn.fadeIn("slow"),this.controls.$zoomOut.fadeIn("slow"),this.controls.$panorama.removeClass("ipnrm-no-zoom")):this.controls.$panorama.addClass("ipnrm-no-zoom"),this.config.showFullscreenCtrl&&(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled)&&this.controls.$fullscreen.fadeIn("slow"),this.config.compass&&this.config.scenes[a].compassNorthOffset?this.controls.$compass.fadeIn("slow"):this.controls.$compass.fadeOut("slow"),this.applyTitle(a)},applyTitle:function(a){if(this.config.title){var b=this.config.scenes[a];if(b.title){var c="function"==typeof b.title?b.title.call(a):b.title;this.controls.$title.empty()[b.titleHtml?"string"==typeof c?"html":"append":"text"](c),this.controls.$title.fadeIn("slow")}else this.controls.$title.fadeOut("slow")}},showMessage:function(b){this.controls.$info.html(b),this.controls.$info.fadeIn(),setTimeout(a.proxy(function(){this.controls.$info.fadeOut()},this),5e3)},destroy:function(){this.resetHotSpots(),this.resetHandlers(),this.resetScene()},util:function(){return null!=this._util?this._util:this._util=new c}},a.fn.ipanorama=function(c,e){return this.each(function(){var f=a(this),g=f.data(d),h=a.isPlainObject(c)?c:{};if("destroy"==c){if(!g)throw Error("Calling 'destroy' method on not initialized instance is forbidden");return f.removeData(d),void g.destroy()}if("loadscene"==c){if(!g)throw Error("Calling 'loadscene' method on not initialized instance is forbidden");if(!e||!e.hasOwnProperty("sceneId"))throw Error("Calling 'loadscene' method without the 'sceneId' parameter is forbidden");return void g.loadScene(e.sceneId)}if("resize"==c){if(!g)throw Error("Calling 'resize' method on not initialized instance is forbidden");return void g.resize()}if(g){var i=a.extend({},g.config,h);g.init(i)}else{var i=a.extend({},b.prototype.defaults,h);g=new b(f,i),f.data(d,g)}})}}(window.jQuery);